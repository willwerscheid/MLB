---
title: "Swing, called strike, contact, and foul probabilities"
author: "Jason Willwerscheid"
date: "2/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, comment = "#>")
```

I'll need four probabilities that condition on pitch location. First, I'll need the probability that an average batter will swing at a pitch, conditional on the pitch count and the location of the pitch. Second, I'll need the probability that a pitch will be called a strike, conditional on the pitch location and the batter not swinging. Third, I'll need the probability that an average batter will make contact with a pitch, conditional on the pitch location and the batter swinging. And finally, I'll need the probability that the ball will be hit foul, conditional on the pitch location and the batter making contact. I make the simplifying assumption that the latter three probabilities are independent of the pitch count. This is not actually true: for example, umpires are more reluctant to call strike three than strikes one and two, and hitters can afford to be choosier when the count is in their favor. It'd be a good idea to revisit this analysis in the future to see how things change when everything is conditioned on pitch count.

## Called strike probabilities

I start by calculating
$$ p(\text{strike} \mid \text{pitch location, no swing}) $$
Note that it's not as simple as looking at whether or not a pitch is located in the strike zone: pitches at the corners are much less likely to be called strikes than pitches over the middle of the plate. Thus I estimate probabilities using empirical proportions. In the plot below, the dashed line indicates the [theoretical strike zone](https://www.baseballprospectus.com/news/article/37347/robo-strike-zone-not-simple-think/).

```{r looks}
suppressMessages(library(tidyverse))

all_pitches <- readRDS("output/mlb_preproc.rds")

plate_left <- -8.5 / 12
plate_right <- 8.5 / 12
sz_left <- plate_left - 2.94 / 2 / 12
sz_right <- plate_right + 2.94 / 2 / 12
sz_bot <- 15.53 / 12
sz_top <- 42.47 / 12

looks <- all_pitches %>%
  filter(swing == 0) %>%
  group_by(plate_x, plate_z) %>%
  summarize(p_strike = sum(called_strike) / sum(swing == 0)) %>%
  ungroup()

ggplot(looks, aes(x = plate_x, y = plate_z, fill = p_strike)) + 
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  geom_rect(aes(xmin = sz_left, xmax = sz_right, ymin = sz_bot, ymax = sz_top),
                col = "black", linetype = "dashed", alpha = 0) +
  geom_segment(aes(x = plate_left, xend = plate_right, y = 0, yend = 0))
```

## Contact probabilities

Next I calculate
$$ p(\text{contact} \mid \text{pitch location, swing}) $$
Recall that I flipped the $x$-axis for left-handed hitters, so there's no need to condition on handedness. The empirical probabilities appear as follows:

```{r contact}
contact <- all_pitches %>%
  group_by(plate_x, plate_z) %>%
  summarize(n = sum(swing == 1), 
            p_contact = ifelse(sum(swing == 1) == 0, 0, 
                               sum(contact == 1) / sum(swing == 1))) %>%
  ungroup() 

ggplot(contact, aes(x = plate_x, y = plate_z, fill = p_contact)) + 
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  geom_rect(aes(xmin = sz_left, xmax = sz_right, ymin = sz_bot, ymax = sz_top),
                col = "black", linetype = "dashed", alpha = 0) +
  geom_segment(aes(x = plate_left, xend = plate_right, y = 0, yend = 0))
```

These probabilities are a bit noisy for pitches that are high and outside (some of these bins have as few as 20 to 30 observations). A very small amount of smoothing goes a long way (I essentially force each bin to use at least 100 observations, borrowing observations from nearby bins when necessary):

```{r smooth_contact}
# knn smoothing
smooth_probs <- function(x, y, n, p, k) {
  dist_mat <- outer(x, x, `-`)^2 + outer(y, y, `-`)^2
  smoothed_probs <- apply(dist_mat, 1, function(x) {
    dist_order <- order(x)
    obs_cumsum <- cumsum(n[dist_order])
    n_bins <- min(which(obs_cumsum >= k))
    dist_order <- dist_order[1:n_bins]
    return(sum(n[dist_order] * p[dist_order]) / sum(n[dist_order]))
  })
  return(smoothed_probs)
}

smooth_contact <- contact %>%
  mutate(p_contact = smooth_probs(plate_x, plate_z, n, p_contact, k = 100)) %>%
  select(-n)

ggplot(smooth_contact, aes(x = plate_x, y = plate_z, fill = p_contact)) + 
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  geom_rect(aes(xmin = sz_left, xmax = sz_right, ymin = sz_bot, ymax = sz_top),
                col = "black", linetype = "dashed", alpha = 0) +
  geom_segment(aes(x = plate_left, xend = plate_right, y = 0, yend = 0))
```

## Foul probabilities

Next up is
$$ p(\text{foul} \mid \text{pitch location, contact}) $$

I again do a small amount of smoothing.

```{r fouls}
fouls <- all_pitches %>%
  filter(contact == 1) %>%
  group_by(plate_x, plate_z) %>%
  summarize(n = n(), p_foul = sum(foul) / n()) %>%
  ungroup() %>%
  mutate(p_foul = smooth_probs(plate_x, plate_z, n, p_foul, k = 100)) %>%
  select(-n)

ggplot(fouls, aes(x = plate_x, y = plate_z, fill = p_foul)) + 
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  geom_rect(aes(xmin = sz_left, xmax = sz_right, ymin = sz_bot, ymax = sz_top),
                col = "black", linetype = "dashed", alpha = 0) +
  geom_segment(aes(x = plate_left, xend = plate_right, y = 0, yend = 0))
```

## Swing probabilities

Finally I calculate
$$ p(\text{swing} \mid \text{count, pitch location}) $$
Few plate appearances go to 3-0, so those probabilites appear noisy even after smoothing, but I prefer to leave the estimates as they are: oversmoothing yields estimates that are too high at the margins (and thus systematically biased rather than merely noisy).

```{r swings}
swings <- all_pitches %>%
  group_by(balls, strikes, plate_x, plate_z) %>%
  summarize(n = n(), p_swing = sum(swing) / n()) %>%
  group_by(balls, strikes) %>%
  mutate(p_swing = smooth_probs(plate_x, plate_z, n, p_swing, k = 100)) %>%
  ungroup() %>%
  select(-n)

ggplot(swings %>% mutate(pitch_count = paste(balls, strikes, sep = "-")), 
       aes(x = plate_x, y = plate_z, fill = p_swing)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  facet_wrap(~pitch_count, nrow = 4, ncol = 3) +
  geom_rect(aes(xmin = sz_left, xmax = sz_right, ymin = sz_bot, ymax = sz_top),
                col = "black", linetype = "dashed", alpha = 0) +
  geom_segment(aes(x = plate_left, xend = plate_right, y = 0, yend = 0))
```

```{r save_res}
pitchloc_res <- list(looks = looks, contact = smooth_contact, fouls = fouls, swings = swings)
saveRDS(pitchloc_res, "output/pitchloc_res.rds")
```