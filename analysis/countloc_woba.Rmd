---
title: "Ball, strike, foul, and hit-into-play values"
author: "Jason Willwerscheid"
date: "2/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, comment = "#>")
```

## Count-specific wOBA

I calculate expected wOBA conditional on the pitch count (the idea is described in Tango, Lichtman, and Dolphin). To account for the juicier balls of 2017 and 2019, I want these on a per-year basis, but for less frequent pitch counts like 3-0, the standard errors associated with the empirical means are a bit too large for my taste. Thus I make the additional assumption that year-to-year differences are constant across pitch counts. (I could have also assumed that the ratios are constant, but differences are easier to interpret.) I give the complete table below: one can verify that the fitted wOBA values are all very reasonable given the empirical wOBAs and SEs, and they have the convenient property that 2017 values are all one point higher than 2019 values, which are in turn 8 points higher than 2018 values.

```{r count_woba}
suppressMessages(library(tidyverse))

all_pitches <- readRDS("output/mlb_wprobs.rds")

count_woba <- all_pitches %>%
  group_by(game_year, balls, strikes) %>%
  summarize(empirical_wOBA = sum(pa_woba_value) / sum(pa_woba_denom),
            empirical_SE = sd(pa_woba_value[pa_woba_denom > 0]) / sqrt(sum(pa_woba_denom))) %>%
  ungroup() %>%
  arrange(balls, strikes, game_year)

lm_fit <- lm(pa_woba_value ~ factor(game_year) + factor(balls)*factor(strikes), 
             data = filter(all_pitches, pa_woba_denom > 0))
lm_preds <- predict(lm_fit, newdata = count_woba)
count_woba <- count_woba %>%
  mutate(fitted_wOBA = lm_preds, 
         diff = fitted_wOBA - empirical_wOBA)

knitr::kable(count_woba, digits = 3)  
```

## wOBA values for pitch events

Next, using the wOBACON calculated [here](countloc_pitchloc.html), I calculate the value of a ball, strike, foul ball, and hit into play conditional on the pitch count (and also conditional on pitch type and location, since the wOBACON depends on these features). 

For example, consider the following pitch:

```{r ex}
set.seed(60666)
ex <- all_pitches %>%
  select(game_year:plate_z, wOBACON) %>%
  sample_n(1)
knitr::kable(ex, digits = 3)
```

In 2018, an 0-2 count is associated with an expected wOBA of 0.205. A ball will bring the count to 1-2, which has a wOBA of 0.228, so the value of a ball at 0-2 is 0.023. (And, due to the convenient assumption I made above, this value is constant from year to year.) A strike will result in a strikeout, which brings the wOBA down to zero: thus the value of a strike at 0-2 is -0.205. A foul ball does not change the count, so its value is zero. Finally, since the pitch is a four-seamer outside, it has a relatively modest conditional wOBACON of 0.377, which yields a hit-into-play value of 0.172.

```{r event_vals}
event_vals <- count_woba %>%
  rename(wOBA = fitted_wOBA) %>%
  select(game_year, balls, strikes, wOBA)

helper_df <- tibble(balls = 4, strikes = 0:2, wOBA = 1, dummy = 1) %>%
  bind_rows(tibble(strikes = 3, balls = 0:3, wOBA = 0, dummy = 1)) %>%
  full_join(tibble(game_year = 2017:2019, dummy = 1), by = "dummy") %>%
  select(-dummy)

event_vals <- event_vals %>%
  bind_rows(helper_df) 
event_vals <- event_vals %>%
  left_join(event_vals, by = "game_year", suffix = c("", "_next")) %>%
  filter((balls_next == balls + 1 & strikes_next == strikes)
         | (strikes_next == strikes + 1 & balls_next == balls)) %>%
  mutate(event = ifelse(strikes_next == strikes + 1, "strike", "ball"), 
         wOBA_change = wOBA_next - wOBA) %>%
  filter(balls < 4, strikes < 3) %>%
  select(game_year, balls, strikes, wOBA, event, wOBA_change) %>%
  spread(key = "event", value = "wOBA_change") %>%
  rename(strike_value = strike, ball_value = ball)
  
# Foul balls:
event_vals <- event_vals %>%
  mutate(foul_value = ifelse(strikes == 2, 0, strike_value))

all_pitches <- all_pitches %>%
  left_join(event_vals, by = c("game_year", "balls", "strikes")) %>%
  mutate(HIP_value = wOBACON - wOBA) %>%
  select(-wOBA)
```

```{r save_res}
saveRDS(all_pitches, "output/mlb_eventvals.rds")
```